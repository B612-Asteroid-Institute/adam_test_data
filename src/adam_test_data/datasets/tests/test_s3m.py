import os
import tempfile

import pyarrow as pa
import pyarrow.compute as pc
import pytest

from ..s3m import load_S3M


@pytest.fixture
def S0():
    # head s0.s3m
    return """!! S3M version 09.05.15
!! S3MID FORMAT q e i Omega argperi t_p H t_0 INDEX N_PAR MOID COMPCODE
S0000001a  COM 1.251458729448 0.382243999742 9.304721017758 252.063850160767 185.610748171983 54067.969963746829 10.315000000000 54466.000000000000 1 6 -1 MOPS
S0000002a  COM 1.286218727856 0.662517753900 18.303864557524 132.486568373398 80.463152617168 54670.088588571860 10.818000000000 54466.000000000000 1 6 -1 MOPS
S0000003a  COM 0.617192824319 0.645272461446 10.302492961463 67.484377997848 182.131418414861 54522.349738469362 11.175000000000 54466.000000000000 1 6 -1 MOPS
S0000004a  COM 0.383305637384 0.856418993311 16.988462723463 117.793282090267 242.430598236459 54973.510299248614 11.452000000000 54466.000000000000 1 6 -1 MOPS
S0000005a  COM 0.569263692349 0.772124864464 22.761089277031 314.323203605280 73.119299008580 54075.567351641024 11.678000000000 54466.000000000000 1 6 -1 MOPS
S0000006a  COM 0.984745120077 0.377978642602 17.600111575186 151.677944867124 105.823145985780 54788.545451754093 11.869000000000 54466.000000000000 1 6 -1 MOPS
S0000007a  COM 0.196442321878 0.726033952419 30.503610309018 103.291864286172 353.107174035836 54544.783776084703 12.035000000000 54466.000000000000 1 6 -1 MOPS
S0000008a  COM 0.395790237647 0.628052442921 32.902888227255 135.381871436121 328.708062113062 54476.005641465534 12.181000000000 54466.000000000000 1 6 -1 MOPS
"""


@pytest.fixture
def S1():
    # head s0_00.s3m
    return """!!S3M V.09.06.15
!!OID FORMAT q e i node argperi t_p H t_0 INDEX N_PAR MOID COMPCODE
S1000000a  COM   3.01822   0.05208  22.56035 211.00286 335.42134  51575.94061 14.20  54800.00000 1 6 -1 Python
S1000001a  COM   2.10974   0.07518   4.91571 209.40298 322.66447  54205.77161 20.57  54800.00000 1 6 -1 Python
S1000002a  COM   2.80523   0.07777   1.24945 112.52284 139.86858  54468.71747 14.65  54800.00000 1 6 -1 Python
S1000003a  COM   2.10917   0.13219   1.46615 266.54621 232.24412  54212.16304 19.58  54800.00000 1 6 -1 Python
S1000004a  COM   2.17676   0.19949  12.92422 162.14580 192.22312  51895.46586 10.56  54800.00000 1 6 -1 Python
S1000007a  COM   1.98262   0.16324  23.42404 210.02222 326.18514  54730.97656  8.17  54800.00000 1 6 -1 Python
S1000008a  COM   1.73305   0.24339  23.73823 337.86076 113.29921  54647.98297  8.97  54800.00000 1 6 -1 Python
S1000009a  COM   2.18691   0.15787  14.26404  63.83526 171.52690  51866.56387 10.73  54800.00000 1 6 -1 Python
"""


@pytest.fixture
def St5():
    # head St5.s3m
    return """!! S3M version 09.06.15
!! S3MID FORMAT q e i Omega argperi t_p H t_0 INDEX N_PAR MOID COMPCODE
St500000a  COM   4.91636   0.05966   7.60840 313.71100 150.14863  47268.27529  5.63  54800.00000 1 6 -1 Python
St500001a  COM   4.96652   0.06370  10.44140 100.53900 243.70619  54669.39282  6.25  54800.00000 1 6 -1 Python
St500002a  COM   5.01980   0.03319   6.72150 166.40400  31.12803  52845.06297  6.36  54800.00000 1 6 -1 Python
St500003a  COM   4.75104   0.09715  18.38590  41.23800 206.31396  54666.09533  6.61  54800.00000 1 6 -1 Python
St500004a  COM   4.91459   0.05269  26.17070 188.83400  92.77871  46950.71510  6.92  54800.00000 1 6 -1 Python
St500005a  COM   4.85598   0.06418  16.68460 287.88700 137.38111  46795.39140  7.00  54800.00000 1 6 -1 Python
St500006a  COM   4.92843   0.06248   9.98380 107.24100  18.90800  47490.32843  7.01  54800.00000 1 6 -1 Python
St500007a  COM   4.75376   0.07996  12.42690 178.47400 264.07675  47230.72577  7.23  54800.00000 1 6 -1 Python
"""


def test_load_S3M(S0, S1, St5):

    with tempfile.TemporaryDirectory() as s3m_dir:

        with open(os.path.join(s3m_dir, "s0.s3m"), "w") as f:
            f.write(S0)
        with open(os.path.join(s3m_dir, "s0_00.s3m"), "w") as f:
            f.write(S1)
        with open(os.path.join(s3m_dir, "St5.s3m"), "w") as f:
            f.write(St5)

        small_bodies = load_S3M(s3m_dir)
        assert len(small_bodies) == 24
        assert pc.equal(
            small_bodies.orbits.orbit_id,
            pa.array(
                [
                    "s3m0000000",
                    "s3m0000001",
                    "s3m0000002",
                    "s3m0000003",
                    "s3m0000004",
                    "s3m0000005",
                    "s3m0000006",
                    "s3m0000007",
                    "s3m0000008",
                    "s3m0000009",
                    "s3m0000010",
                    "s3m0000011",
                    "s3m0000012",
                    "s3m0000013",
                    "s3m0000014",
                    "s3m0000015",
                    "s3m0000016",
                    "s3m0000017",
                    "s3m0000018",
                    "s3m0000019",
                    "s3m0000020",
                    "s3m0000021",
                    "s3m0000022",
                    "s3m0000023",
                ]
            ),
        )

        assert pc.equal(
            small_bodies.orbits.object_id,
            pa.array(
                [
                    "S0000001a",
                    "S0000002a",
                    "S0000003a",
                    "S0000004a",
                    "S0000005a",
                    "S0000006a",
                    "S0000007a",
                    "S0000008a",
                    "S1000000a",
                    "S1000001a",
                    "S1000002a",
                    "S1000003a",
                    "S1000004a",
                    "S1000007a",
                    "S1000008a",
                    "S1000009a",
                    "St500000a",
                    "St500001a",
                    "St500002a",
                    "St500003a",
                    "St500004a",
                    "St500005a",
                    "St500006a",
                    "St500007a",
                ]
            ),
        )
